<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SPLITT v3 - Split Bills Instantly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-light: #1f1f1f;
            --border: #2a2a2a;
            --primary: #8B5CF6;
            --success: #22c55e;
            --warning: #facc15;
            --error: #dc2626;
            --text: #ffffff;
            --text-secondary: #a1a1a1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        .screen { display: none; min-height: 100vh; animation: slideIn 0.3s ease; }
        .screen.active { display: flex; flex-direction: column; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); } 50% { box-shadow: 0 0 0 15px rgba(139, 92, 246, 0); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.2); } 50% { box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); } }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        .btn { min-height: 60px; padding: 0 32px; border-radius: 14px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.2s; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: black; }
        .btn-warning { background: var(--yellow); color: black; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .input { width: 100%; min-height: 60px; padding: 16px 20px; background: var(--surface); border: 2px solid var(--border); border-radius: 12px; color: var(--text); font-size: 18px; margin-bottom: 12px; }
        .input:focus { outline: none; border-color: var(--primary); }
        .card { background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 12px; }
        .emoji-bounce { animation: bounce 1.5s infinite; }
        .pulse-ring { animation: pulse 2s infinite; }
        .orphan-glow { animation: glow 2s infinite; border-color: var(--yellow) !important; }
        .nav { position: fixed; top: 0; left: 0; right: 0; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(10,10,10,0.95); backdrop-filter: blur(10px); z-index: 100; border-bottom: 1px solid var(--border); }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); border: 2px solid var(--border); border-radius: 20px; padding: 24px; width: 100%; max-width: 400px; }
        .pin-input { width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: 900; padding: 0; background: var(--surface); border: 2px solid var(--border); border-radius: 12px; color: var(--text); }
        .progress-bar { width: 100%; height: 8px; background: var(--surface-light); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); transition: width 0.3s ease; }
        .avatar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 12px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; background: var(--surface-light); display: flex; align-items: center; justify-content: center; font-size: 28px; border: 3px solid var(--border); animation: popIn 0.3s ease; }
        .avatar.me { border-color: var(--primary); animation: popIn 0.3s ease, pulse 2s infinite; }
        .claimant-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--surface-light); border-radius: 20px; font-size: 13px; margin: 4px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav" id="nav" style="display: none;">
        <div class="text-2xl font-black" style="color: var(--primary);">SPLITT</div>
        <div class="font-mono text-sm px-4 py-2 rounded-lg" style="border: 2px solid var(--warning); color: var(--warning);" id="roomDisplay"></div>
    </nav>

    <!-- Screen 1: Welcome -->
    <div class="screen active" id="welcomeScreen">
        <div class="flex-1 flex flex-col items-center justify-center p-6 text-center">
            <div class="text-8xl mb-6 emoji-bounce">üí∏</div>
            <h1 class="text-4xl font-black mb-3">Split bills<br><span style="color: var(--primary);">in seconds</span></h1>
            <p class="text-lg mb-8" style="color: var(--text-secondary);">No accounts. No downloads.<br>Just scan, claim, and pay.</p>
            <div class="w-full max-w-sm space-y-4">
                <button class="btn btn-primary w-full text-xl" onclick="createRoom()">New Split</button>
                <button class="btn btn-outline w-full" onclick="showJoin()">Join Split</button>
            </div>
        </div>
    </div>

    <!-- Screen 2: Join Modal -->
    <div class="modal" id="joinModal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Enter Room Code</h3>
            <div class="flex gap-2 justify-center mb-6">
                <input type="text" class="pin-input" id="p1" maxlength="1" oninput="nextPin(1)">
                <input type="text" class="pin-input" id="p2" maxlength="1" oninput="nextPin(2)">
                <input type="text" class="pin-input" id="p3" maxlength="1" oninput="nextPin(3)">
                <input type="text" class="pin-input" id="p4" maxlength="1" oninput="nextPin(4)">
                <input type="text" class="pin-input" id="p5" maxlength="1" oninput="nextPin(5)">
                <input type="text" class="pin-input" id="p6" maxlength="1" oninput="joinRoom()">
            </div>
            <div class="flex gap-3">
                <button class="btn btn-outline flex-1" onclick="hideJoin()">Cancel</button>
                <button class="btn btn-primary flex-1" onclick="joinRoom()">Join</button>
            </div>
        </div>
    </div>

    <!-- Screen 3: Name/Avatar -->
    <div class="modal" id="nameModal">
        <div class="modal-content">
            <button onclick="backToWelcome()" class="text-sm mb-4" style="color: var(--text-secondary); background: none; border: none; cursor: pointer;">‚Üê Back</button>
            <h3 class="text-xl font-bold mb-4">Who are you?</h3>
            <input type="text" class="input mb-4" id="userName" placeholder="Your name" maxlength="12">
            <div class="grid grid-cols-5 gap-2 mb-6" id="emojiGrid"></div>
            <button class="btn btn-primary w-full" onclick="setUser()">Continue</button>
        </div>
    </div>

    <!-- Add Missing Item Modal -->
    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Add Missing Item</h3>
            <input type="text" class="input mb-3" id="newItemName" placeholder="Item name (e.g., Chicken Wings)">
            <input type="number" class="input mb-3" id="newItemPrice" placeholder="Price (e.g., 12.99)" step="0.01" min="0">
            <input type="number" class="input mb-4" id="newItemQty" placeholder="Quantity" value="1" min="1">
            <div class="flex gap-3">
                <button class="btn btn-outline flex-1" onclick="hideAddItemModal()">Cancel</button>
                <button class="btn btn-success flex-1" onclick="addMissingItem()">Add Item</button>
            </div>
        </div>
    </div>

    <!-- Screen 4: Lobby -->
    <div class="screen" id="lobbyScreen">
        <div class="pt-20 px-6">
            <div class="text-center mb-6">
                <div class="text-sm mb-2" style="color: var(--text-secondary);">ROOM CODE</div>
                <div class="text-5xl font-black font-mono tracking-widest mb-4" id="lobbyCode" style="color: var(--warning);"></div>
                <div class="text-sm" style="color: var(--text-secondary);">Share this code with friends</div>
            </div>
            <div class="card mb-6">
                <div class="text-sm mb-3" style="color: var(--text-secondary);">Who's here:</div>
                <div class="avatar-grid" id="playerList"></div>
            </div>
            <div class="space-y-3">
                <button class="btn btn-success w-full" id="startBtn" onclick="goToReceipt()" style="display: none;">Start Splitting</button>
                <button class="btn btn-outline w-full" onclick="leaveRoom()">Leave Room</button>
            </div>
        </div>
    </div>

    <!-- Screen 5: Receipt -->
    <div class="screen" id="receiptScreen">
        <div class="pt-20 px-6 flex-1 flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Add Receipt</h2>
            <div class="flex gap-2 mb-4">
                <button class="btn btn-sm flex-1 text-sm py-2" onclick="setTab('camera')" id="tab-camera" style="min-height: 44px; background: var(--primary);">üì∑ Camera</button>
                <button class="btn btn-outline flex-1 text-sm py-2" onclick="setTab('paste')" id="tab-paste" style="min-height: 44px;">Paste</button>
                <button class="btn btn-outline flex-1 text-sm py-2" onclick="setTab('manual')" id="tab-manual" style="min-height: 44px;">Manual</button>
            </div>
            
            <!-- Camera Tab -->
            <div id="cameraSection" class="flex-1 flex flex-col">
                <input type="file" id="receiptImage" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                <div id="cameraPreview" class="hidden flex-1 flex flex-col">
                    <img id="previewImg" class="w-full max-h-64 object-contain rounded-xl mb-4 bg-black">
                    <div id="scanningOverlay" class="hidden relative">
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-green-500/20 to-transparent h-8 animate-pulse"></div>
                        <div class="text-center text-green-400 font-bold">üîç Scanning receipt...</div>
                    </div>
                </div>
                <div id="cameraButtons" class="flex-1 flex flex-col justify-center gap-4">
                    <div id="ocrLoading" class="hidden text-center mb-4">
                        <div class="text-yellow-400 font-bold mb-2">üì¶ Loading OCR engine...</div>
                        <div class="text-sm" style="color: var(--text-secondary);">First time only (2-3MB)</div>
                    </div>
                    <button class="btn btn-primary w-full" onclick="triggerCamera()">
                        üì∑ Take Photo
                    </button>
                    <button class="btn btn-outline w-full" onclick="triggerGallery()">
                        üñºÔ∏è Choose from Gallery
                    </button>
                    <div class="text-center text-xs mt-4" style="color: var(--text-secondary);">
                        üí° Tip: Make sure receipt is well-lit and flat
                    </div>
                </div>
                <div id="cameraResults" class="hidden flex-1 overflow-y-auto">
                    <div class="text-sm mb-2" style="color: var(--text-secondary);">Extracted Items:</div>
                    <div id="extractedItems" class="space-y-2"></div>
                    
                    <!-- Add Missing Item Button -->
                    <button class="btn btn-outline w-full mt-3 mb-2" onclick="showAddItemModal()" style="min-height: 44px; font-size: 14px;">
                        ‚ûï Add Missing Item
                    </button>
                    
                    <!-- Receipt Summary -->
                    <div id="receiptSummary" class="hidden card mt-4" style="border-color: var(--success);">
                        <div class="text-sm font-bold mb-2" style="color: var(--success);">‚úì Scanned Summary</div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span style="color: var(--text-secondary);">Subtotal:</span><span id="scannedSubtotal">$0.00</span></div>
                            <div class="flex justify-between"><span style="color: var(--text-secondary);">Tax:</span><span id="scannedTax">$0.00</span></div>
                            <div class="flex justify-between"><span style="color: var(--text-secondary);">Tip:</span><span id="scannedTip">$0.00</span></div>
                            <div class="border-t pt-2 mt-2 flex justify-between font-bold" style="border-color: var(--border);"><span>Total:</span><span id="scannedTotal" style="color: var(--success);">$0.00</span></div>
                        </div>
                        <div class="mt-3 text-xs text-center" style="color: var(--text-secondary);">üëÜ Double-check items above before continuing</div>
                    </div>
                </div>
            </div>
            
            <!-- Paste Tab -->
            <div id="pasteSection" class="hidden flex-1 flex flex-col">
                <textarea class="input flex-1 font-mono text-sm" id="receiptText" placeholder="Paste receipt text here...

Example:
2x Chicken Wings $24.00
Caesar Salad $12.50
Tax $3.65
Tip $8.00
Total $48.15"></textarea>
            </div>
            
            <!-- Manual Tab -->
            <div id="manualInput" class="hidden flex-1 flex flex-col">
                <input type="text" class="input" id="manualName" placeholder="Item name">
                <input type="number" class="input" id="manualPrice" placeholder="Price" step="0.01">
                <button class="btn btn-outline w-full mb-4" onclick="addManualItem()">Add Item</button>
            </div>
            
            <div class="card mb-4 max-h-48 overflow-y-auto" id="previewBox">
                <div class="text-center py-8" style="color: var(--text-secondary);">Receipt preview will appear here</div>
            </div>
            <button class="btn btn-success w-full mb-6" id="continueBtn" onclick="processReceipt()" disabled style="opacity: 0.5;">üì∑ Upload a receipt first</button>
        </div>
    </div>

    <!-- Screen 6: Item Selection -->
    <div class="screen" id="selectScreen">
        <div class="pt-20 px-6 flex-1 flex flex-col">
            <div class="mb-4">
                <h2 class="text-xl font-bold">Claim Your Items</h2>
                <div class="progress-bar mt-2">
                    <div class="progress-fill" id="claimProgress" style="width: 0%"></div>
                </div>
            </div>
            <div class="card orphan-glow mb-4 hidden" id="orphanAlert">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <span><strong id="orphanCount">0</strong> items still need to be claimed!</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3 pb-4" id="itemsList"></div>
            <div class="pt-4 pb-6">
                <div class="flex justify-between items-center mb-3">
                    <span style="color: var(--text-secondary);">Your Total:</span>
                    <span class="text-2xl font-black" style="color: var(--success);" id="runningTotal">$0.00</span>
                </div>
                <button class="btn btn-success w-full" onclick="reviewSplit()">Review Split ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Screen 7: Personal Review -->
    <div class="screen" id="reviewScreen">
        <div class="pt-20 px-6">
            <h2 class="text-2xl font-bold mb-6 text-center">Your Split</h2>
            <div class="text-center mb-6">
                <div class="text-6xl font-black mb-2" style="color: var(--success);" id="yourTotalDisplay">$0.00</div>
                <div style="color: var(--text-secondary);">You owe</div>
            </div>
            <div class="card mb-6">
                <div class="text-sm mb-3" style="color: var(--text-secondary);">YOUR ITEMS:</div>
                <div id="yourItems" class="space-y-2"></div>
                <div class="border-t mt-4 pt-4 space-y-2" style="border-color: var(--border);">
                    <div class="flex justify-between"><span style="color: var(--text-secondary);">Subtotal</span><span id="yourSubtotal">$0.00</span></div>
                    <div class="flex justify-between"><span style="color: var(--text-secondary);">Tax</span><span id="yourTax">$0.00</span></div>
                    <div class="flex justify-between"><span style="color: var(--text-secondary);">Tip</span><span id="yourTip">$0.00</span></div>
                </div>
            </div>
            <button class="btn btn-success w-full" onclick="goToFinal()">Looks Good ‚úì</button>
        </div>
    </div>

    <!-- Screen 8: Group Settlement -->
    <div class="screen" id="finalScreen">
        <div class="pt-20 px-6">
            <h2 class="text-2xl font-bold mb-6">Final Split</h2>
            <div id="finalLeaderboard" class="space-y-3 mb-6"></div>
            <div class="card mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span style="color: var(--text-secondary);">Total Bill</span>
                    <span class="font-bold" id="billTotal">$0.00</span>
                </div>
                <div class="flex justify-between items-center">
                    <span style="color: var(--text-secondary);">Split between</span>
                    <span id="splitCountDisplay">0 people</span>
                </div>
            </div>
            <button class="btn btn-outline w-full" onclick="resetApp()">Start New Split</button>
        </div>
    </div>

    <script>
        /**
         * SPLITT - Logic & State
         */

        class ReceiptParser {
          constructor() {
            // Simple approach: find all prices, identify which are tax/tip/total, rest are items
          }

          extractAllPrices(text) {
            // Find all dollar amounts in the text
            const priceRegex = /[$‚Ç¨¬£]?\s*(\d{1,3}(?:[,\s]?\d{3})*)\s*[\.\,]\s*(\d{2})/g;
            const matches = [];
            let match;
            while ((match = priceRegex.exec(text)) !== null) {
              const raw = match[0];
              const dollars = match[1].replace(/[,\s]/g, '');
              const cents = match[2];
              const value = parseFloat(`${dollars}.${cents}`);
              // Find the line this price is on
              const lineStart = text.lastIndexOf('\n', match.index) + 1;
              const lineEnd = text.indexOf('\n', match.index);
              const line = text.substring(lineStart, lineEnd > -1 ? lineEnd : text.length).trim();
              matches.push({ raw, value, line, index: match.index });
            }
            return matches;
          }

          identifyLineType(line) {
            const lower = line.toLowerCase();
            
            // Check for total (but not subtotal)
            if ((lower.includes('total') || lower.includes('amount due') || lower.includes('balance')) && 
                !lower.includes('subtotal')) {
              return 'total';
            }
            
            // Check for tax
            if (lower.includes('tax') || lower.includes('vat') || lower.includes('gst')) {
              return 'tax';
            }
            
            // Check for tip/gratuity
            if (lower.includes('tip') || lower.includes('gratuity') || lower.includes('service charge')) {
              return 'tip';
            }
            
            // Check for subtotal
            if (lower.includes('subtotal') || lower.includes('sub total')) {
              return 'subtotal';
            }
            
            return 'item';
          }

          cleanItemName(line, price) {
            // Remove the price from the line
            let name = line.replace(/[$‚Ç¨¬£]?\s*\d[\d,\s]*[\.\,]\s*\d{2}/, '').trim();
            
            // Remove common prefixes
            name = name.replace(/^(\d+\s*[@x√ó\*]?\s+)/, ''); // Remove quantities like "2x "
            name = name.replace(/^[@#]\s*/, ''); // Remove @ or # at start
            
            // Clean up
            name = name.replace(/\s+/g, ' ').trim();
            
            return name;
          }

          isValidItem(name) {
            if (!name || name.length < 2) return false;
            
            // Must have at least one letter
            if (!/[a-zA-Z]/.test(name)) return false;
            
            // Skip obvious non-items
            const lower = name.toLowerCase();
            const skipWords = ['total', 'tax', 'tip', 'subtotal', 'phone', 'fax', 'email', 
                             'www', 'http', 'date', 'time', 'server', 'cashier', 'payment',
                             'card', 'credit', 'debit', 'change', 'balance', 'zip', 'code'];
            
            for (const word of skipWords) {
              if (lower.includes(word)) return false;
            }
            
            // Skip if looks like an address (starts with number and street type)
            if (/^\d+\s+(st|ave|rd|dr|blvd|ln|ct|way|pl)/i.test(lower)) return false;
            
            // Skip if it's just a ZIP code
            if (/^\d{5}(-\d{4})?$/.test(name)) return false;
            
            return true;
          }

          parseReceiptText(text) {
            if (!text) return { items: [], tax: 0, tip: 0, total: 0 };
            
            const prices = this.extractAllPrices(text);
            
            let items = [];
            let tax = 0;
            let tip = 0;
            let total = 0;
            let subtotal = 0;
            
            // Sort prices by value (largest first) to identify total more easily
            const sortedPrices = [...prices].sort((a, b) => b.value - a.value);
            
            // The largest price is usually the total
            if (sortedPrices.length > 0) {
              const largest = sortedPrices[0];
              const largestType = this.identifyLineType(largest.line);
              
              // If the largest amount's line says "total", it's definitely the total
              if (largestType === 'total' || largest.value > 10) {
                total = largest.value;
              }
            }
            
            // Process each price
            for (const price of prices) {
              const type = this.identifyLineType(price.line);
              
              if (type === 'total') {
                total = price.value;
              } else if (type === 'tax') {
                tax = price.value;
              } else if (type === 'tip') {
                tip = price.value;
              } else if (type === 'subtotal') {
                subtotal = price.value;
              } else {
                // It's likely an item
                const name = this.cleanItemName(price.line, price.value);
                
                // Skip if price equals total, tax, or tip (already counted)
                if (price.value === total || price.value === tax || price.value === tip) {
                  continue;
                }
                
                // Skip very small amounts (likely not items)
                if (price.value < 0.5) continue;
                
                if (this.isValidItem(name)) {
                  // Try to extract quantity
                  let qty = 1;
                  const qtyMatch = price.line.match(/^(\d+)\s*[@x√ó\*]/i);
                  if (qtyMatch) {
                    qty = parseInt(qtyMatch[1]);
                  }
                  
                  items.push({ name, price: price.value, quantity: qty });
                }
              }
            }
            
            // Combine duplicates (same name) by adding quantities, but keep different items
            const combinedItems = [];
            const itemMap = new Map();
            
            for (const item of items) {
              const key = item.name.toLowerCase().trim();
              if (itemMap.has(key)) {
                // Same item found again - add to quantity
                const existing = itemMap.get(key);
                existing.quantity += item.quantity;
                existing.price += item.price; // Add the price too (it's the same item)
              } else {
                // New item
                const newItem = { ...item };
                combinedItems.push(newItem);
                itemMap.set(key, newItem);
              }
            }
            
            // If we found a total but no subtotal, calculate it
            if (total > 0 && subtotal === 0) {
              subtotal = total - tax - tip;
            }
            
            return { items: combinedItems, tax, tip, total };
          }
        }

        const EMOJIS = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','üê§','ü¶Ü'];
        const parser = new ReceiptParser();
        
        let state = {
            roomCode: null,
            userId: null,
            userName: null,
            userEmoji: null,
            isHost: false,
            session: {
                participants: [],
                items: [],
                tax: 0,
                tip: 0,
                selections: {}, // itemId -> Array of {userId, type, value}
                status: 'lobby',
                lastModified: 0
            }
        };

        window.onload = () => {
            loadSession();
            initEmojiGrid();
            startSync();
        };

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
        function generateCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }

        function loadSession() {
            const saved = localStorage.getItem('splitt_user_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.roomCode) {
                    state = parsed;
                    const roomData = localStorage.getItem('room_' + state.roomCode);
                    if (roomData) state.session = JSON.parse(roomData);
                    showScreen(state.session.status === 'lobby' ? 'lobby' : (state.session.status === 'selecting' ? 'select' : 'final'));
                    updateUI();
                }
            }
        }

        function saveSession() {
            state.session.lastModified = Date.now();
            localStorage.setItem('splitt_user_state', JSON.stringify(state));
            localStorage.setItem('room_' + state.roomCode, JSON.stringify(state.session));
        }

        function startSync() {
            setInterval(() => {
                if (state.roomCode) {
                    const data = localStorage.getItem('room_' + state.roomCode);
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (parsed.lastModified > state.session.lastModified) {
                            state.session = parsed;
                            updateUI();
                        }
                    }
                }
            }, 1000);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id + 'Screen').classList.add('active');
            document.getElementById('nav').style.display = id === 'welcome' ? 'none' : 'flex';
        }

        function createRoom() {
            state.roomCode = generateCode();
            state.isHost = true;
            state.userId = generateId();
            showNameModal();
        }

        function showJoin() { document.getElementById('joinModal').classList.add('active'); document.getElementById('p1').focus(); }
        function hideJoin() { document.getElementById('joinModal').classList.remove('active'); }
        function nextPin(n) { if (n < 6) document.getElementById('p' + (n + 1)).focus(); }

        function joinRoom() {
            const code = [1,2,3,4,5,6].map(i => document.getElementById('p'+i).value).join('').toUpperCase();
            if (code.length < 6) return;
            if (!localStorage.getItem('room_' + code)) return alert('Room not found!');
            state.roomCode = code;
            state.isHost = false;
            state.userId = generateId();
            hideJoin();
            showNameModal();
        }

        function showNameModal() { document.getElementById('nameModal').classList.add('active'); }
        
        function backToWelcome() {
            // Reset state
            state.roomCode = null;
            state.isHost = false;
            state.userId = null;
            document.getElementById('nameModal').classList.remove('active');
            document.getElementById('userName').value = '';
            showScreen('welcome');
        }
        
        function initEmojiGrid() {
            const grid = document.getElementById('emojiGrid');
            EMOJIS.forEach((e, i) => {
                const d = document.createElement('div');
                d.className = 'avatar cursor-pointer' + (i === 0 ? ' me' : '');
                d.textContent = e;
                d.onclick = () => {
                    document.querySelectorAll('#emojiGrid .avatar').forEach(a => a.classList.remove('me'));
                    d.classList.add('me');
                    state.userEmoji = e;
                };
                grid.appendChild(d);
            });
            state.userEmoji = EMOJIS[0];
        }

        function setUser() {
            const name = document.getElementById('userName').value.trim();
            if (!name) return;
            state.userName = name;
            state.session.participants.push({ id: state.userId, name, emoji: state.userEmoji, isHost: state.isHost });
            document.getElementById('nameModal').classList.remove('active');
            document.getElementById('roomDisplay').textContent = state.roomCode;
            saveSession();
            showLobby();
        }

        function showLobby() {
            showScreen('lobby');
            document.getElementById('lobbyCode').textContent = state.roomCode;
            document.getElementById('startBtn').style.display = state.isHost ? 'block' : 'none';
            renderPlayers();
        }

        function renderPlayers() {
            const list = document.getElementById('playerList');
            list.innerHTML = '';
            state.session.participants.forEach(p => {
                const d = document.createElement('div');
                d.className = 'flex flex-col items-center gap-1';
                d.innerHTML = `<div class="avatar ${p.id === state.userId ? 'me' : ''}">${p.emoji}</div><div class="text-xs text-gray-400">${p.name}</div>`;
                list.appendChild(d);
            });
        }

        function goToReceipt() { state.session.status = 'receipt'; saveSession(); showScreen('receipt'); }

        function setTab(t) {
            document.getElementById('cameraSection').classList.toggle('hidden', t !== 'camera');
            document.getElementById('pasteSection').classList.toggle('hidden', t !== 'paste');
            document.getElementById('manualInput').classList.toggle('hidden', t !== 'manual');
            document.getElementById('tab-camera').style.background = t === 'camera' ? 'var(--primary)' : 'transparent';
            document.getElementById('tab-paste').style.background = t === 'paste' ? 'var(--primary)' : 'transparent';
            document.getElementById('tab-manual').style.background = t === 'manual' ? 'var(--primary)' : 'transparent';
            
            // Update continue button based on tab and state
            const continueBtn = document.getElementById('continueBtn');
            if (t === 'paste') {
                // Enable for paste tab (user can type manually)
                continueBtn.disabled = false;
                continueBtn.style.opacity = '1';
                continueBtn.textContent = 'Continue';
            } else if (t === 'manual') {
                // Enable for manual tab
                continueBtn.disabled = false;
                continueBtn.style.opacity = '1';
                continueBtn.textContent = 'Continue';
            } else if (t === 'camera') {
                // For camera tab, check if we have scanned items
                if (extractedItemsFromImage.length === 0) {
                    continueBtn.disabled = true;
                    continueBtn.style.opacity = '0.5';
                    continueBtn.textContent = 'üì∑ Upload a receipt first';
                } else {
                    continueBtn.disabled = false;
                    continueBtn.style.opacity = '1';
                    continueBtn.textContent = '‚úì Continue';
                }
            }
        }

        let extractedItemsFromImage = [];

        function triggerCamera() {
            const input = document.getElementById('receiptImage');
            input.setAttribute('capture', 'environment');
            input.click();
        }

        function triggerGallery() {
            const input = document.getElementById('receiptImage');
            input.removeAttribute('capture');
            input.click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('cameraPreview').classList.remove('hidden');
                document.getElementById('cameraButtons').classList.add('hidden');
                document.getElementById('scanningOverlay').classList.remove('hidden');
                
                // Simulate OCR processing
                setTimeout(() => {
                    simulateOCR();
                }, 2000);
            };
            reader.readAsDataURL(file);
        }

        async function simulateOCR() {
            const img = document.getElementById('previewImg');
            const scanningOverlay = document.getElementById('scanningOverlay');
            const continueBtn = document.getElementById('continueBtn');
            
            // Disable continue button while scanning
            continueBtn.disabled = true;
            continueBtn.style.opacity = '0.5';
            continueBtn.textContent = 'üîç Scanning...';
            
            try {
                scanningOverlay.innerHTML = '<div class="text-center text-green-400 font-bold">üìñ Reading receipt...</div>';
                
                // Use Tesseract.js for real OCR
                const result = await Tesseract.recognize(img.src, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            scanningOverlay.innerHTML = `<div class="text-center text-green-400 font-bold">üîç ${Math.round(m.progress * 100)}%</div>`;
                        }
                    }
                });
                
                const text = result.data.text;
                console.log('OCR Result:', text);
                
                // Parse the OCR text
                const parsed = parser.parseReceiptText(text);
                
                // Convert to extracted items format
                extractedItemsFromImage = parsed.items.map(item => ({
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity || 1
                }));
                
                // Add tax/tip if found
                if (parsed.tax > 0) {
                    extractedItemsFromImage.push({ name: 'Tax', price: parsed.tax, quantity: 1, isTax: true });
                }
                if (parsed.tip > 0) {
                    extractedItemsFromImage.push({ name: 'Tip', price: parsed.tip, quantity: 1, isTip: true });
                }
                
                // If no items found, show raw text for manual editing
                if (extractedItemsFromImage.length === 0) {
                    document.getElementById('receiptText').value = text;
                    setTab('paste');
                    alert('Could not parse receipt automatically. Please review the text and edit as needed.');
                    scanningOverlay.classList.add('hidden');
                    // Enable continue button for manual mode
                    continueBtn.disabled = false;
                    continueBtn.style.opacity = '1';
                    continueBtn.textContent = 'Continue';
                    return;
                }
                
                scanningOverlay.classList.add('hidden');
                document.getElementById('cameraResults').classList.remove('hidden');
                renderExtractedItems();
                
                // Show summary
                showReceiptSummary(parsed);
                
                // Enable continue button after successful scan
                continueBtn.disabled = false;
                continueBtn.style.opacity = '1';
                continueBtn.textContent = '‚úì Continue';
                
            } catch (error) {
                console.error('OCR Error:', error);
                scanningOverlay.innerHTML = '<div class="text-center text-red-400 font-bold">‚ùå Error reading receipt</div>';
                continueBtn.textContent = '‚ùå Error - Try Paste Instead';
                setTimeout(() => {
                    scanningOverlay.classList.add('hidden');
                    setTab('paste');
                    continueBtn.disabled = false;
                    continueBtn.style.opacity = '1';
                    continueBtn.textContent = 'Continue';
                }, 2000);
            }
        }
        
        function showReceiptSummary(parsed) {
            const foodItems = parsed.items;
            // Note: item.price is already the total for that line (after combining duplicates)
            // So we just sum the prices, not multiply by quantity
            const subtotal = foodItems.reduce((sum, item) => sum + item.price, 0);
            const total = subtotal + parsed.tax + parsed.tip;
            
            document.getElementById('scannedSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('scannedTax').textContent = '$' + parsed.tax.toFixed(2);
            document.getElementById('scannedTip').textContent = '$' + parsed.tip.toFixed(2);
            document.getElementById('scannedTotal').textContent = '$' + total.toFixed(2);
            document.getElementById('receiptSummary').classList.remove('hidden');
        }

        function renderExtractedItems() {
            const container = document.getElementById('extractedItems');
            container.innerHTML = '';
            
            extractedItemsFromImage.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 rounded-lg';
                div.style.background = item.isTax || item.isTip ? 'rgba(139, 92, 246, 0.1)' : 'var(--surface-light)';
                div.innerHTML = `
                    <div>
                        <div class="font-bold">${item.quantity > 1 ? item.quantity + 'x ' : ''}${item.name}</div>
                        ${item.isTax || item.isTip ? '<div class="text-xs text-purple-400">Auto-detected</div>' : ''}
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-green-400">$${item.price.toFixed(2)}</span>
                        <button class="text-red-400" onclick="removeExtractedItem(${i})">‚úï</button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // Update preview box
            const previewBox = document.getElementById('previewBox');
            previewBox.innerHTML = extractedItemsFromImage.filter(i => !i.isTax && !i.isTip).map(item => `
                <div class="flex justify-between py-2 border-b" style="border-color: var(--border);">
                    <span>${item.quantity > 1 ? item.quantity + 'x ' : ''}${item.name}</span>
                    <span>$${item.price.toFixed(2)}</span>
                </div>
            `).join('');
            
            // Set the session items
            const foodItems = extractedItemsFromImage.filter(i => !i.isTax && !i.isTip);
            const taxItem = extractedItemsFromImage.find(i => i.isTax);
            const tipItem = extractedItemsFromImage.find(i => i.isTip);
            
            state.session.items = foodItems.map((it, i) => ({ ...it, id: 'it_' + i }));
            state.session.tax = taxItem ? taxItem.price : 0;
            state.session.tip = tipItem ? tipItem.price : 0;
        }

        function removeExtractedItem(index) {
            extractedItemsFromImage.splice(index, 1);
            renderExtractedItems();
            
            // Update continue button and summary if no items left
            const continueBtn = document.getElementById('continueBtn');
            if (extractedItemsFromImage.length === 0) {
                continueBtn.disabled = true;
                continueBtn.style.opacity = '0.5';
                continueBtn.textContent = 'üì∑ Upload a receipt first';
                document.getElementById('receiptSummary').classList.add('hidden');
            } else {
                // Recalculate and show updated summary (price is already total)
                const foodItems = extractedItemsFromImage.filter(i => !i.isTax && !i.isTip);
                const taxItem = extractedItemsFromImage.find(i => i.isTax);
                const tipItem = extractedItemsFromImage.find(i => i.isTip);
                const subtotal = foodItems.reduce((sum, item) => sum + item.price, 0);
                const tax = taxItem ? taxItem.price : 0;
                const tip = tipItem ? tipItem.price : 0;
                const total = subtotal + tax + tip;
                
                document.getElementById('scannedSubtotal').textContent = '$' + subtotal.toFixed(2);
                document.getElementById('scannedTax').textContent = '$' + tax.toFixed(2);
                document.getElementById('scannedTip').textContent = '$' + tip.toFixed(2);
                document.getElementById('scannedTotal').textContent = '$' + total.toFixed(2);
            }
        }

        function showAddItemModal() {
            document.getElementById('addItemModal').classList.add('active');
            document.getElementById('newItemName').focus();
        }

        function hideAddItemModal() {
            document.getElementById('addItemModal').classList.remove('active');
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemPrice').value = '';
            document.getElementById('newItemQty').value = '1';
        }

        function addMissingItem() {
            const name = document.getElementById('newItemName').value.trim();
            const price = parseFloat(document.getElementById('newItemPrice').value);
            const qty = parseInt(document.getElementById('newItemQty').value) || 1;
            
            if (!name || isNaN(price) || price <= 0) {
                alert('Please enter a valid item name and price');
                return;
            }
            
            extractedItemsFromImage.push({ name, price, quantity: qty });
            renderExtractedItems();
            
            // Recalculate summary (price is already total for that item)
            const foodItems = extractedItemsFromImage.filter(i => !i.isTax && !i.isTip);
            const taxItem = extractedItemsFromImage.find(i => i.isTax);
            const tipItem = extractedItemsFromImage.find(i => i.isTip);
            const subtotal = foodItems.reduce((sum, item) => sum + item.price, 0);
            const tax = taxItem ? taxItem.price : 0;
            const tip = tipItem ? tipItem.price : 0;
            const total = subtotal + tax + tip;
            
            document.getElementById('scannedSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('scannedTax').textContent = '$' + tax.toFixed(2);
            document.getElementById('scannedTip').textContent = '$' + tip.toFixed(2);
            document.getElementById('scannedTotal').textContent = '$' + total.toFixed(2);
            document.getElementById('receiptSummary').classList.remove('hidden');
            
            // Enable continue button
            const continueBtn = document.getElementById('continueBtn');
            continueBtn.disabled = false;
            continueBtn.style.opacity = '1';
            continueBtn.textContent = '‚úì Continue';
            
            hideAddItemModal();
        }

        function processReceipt() {
            // Check if we have items from camera or from text paste
            if (extractedItemsFromImage.length > 0) {
                // Already set from camera
            } else {
                const text = document.getElementById('receiptText').value;
                const parsed = parser.parseReceiptText(text);
                state.session.items = parsed.items.map((it, i) => ({ ...it, id: 'it_' + i }));
                state.session.tax = parsed.tax;
                state.session.tip = parsed.tip;
            }
            
            if (state.session.items.length === 0) {
                alert('No items found! Please add items first.');
                return;
            }
            
            state.session.status = 'selecting';
            saveSession();
            showSelection();
        }

        function showSelection() {
            showScreen('select');
            renderItems();
        }

        function renderItems() {
            const list = document.getElementById('itemsList');
            list.innerHTML = '';
            let mySub = 0;
            let orphans = 0;

            state.session.items.forEach(it => {
                const selections = state.session.selections[it.id] || [];
                const mySel = selections.find(s => s.userId === state.userId);
                if (selections.length === 0) orphans++;

                if (mySel) {
                    if (mySel.type === 'solo') mySub += it.price;
                    else mySub += it.price / selections.length;
                }

                const d = document.createElement('div');
                d.className = 'item-card ' + (selections.length === 0 ? 'unclaimed' : '');
                let claimants = selections.map(s => {
                    const p = state.session.participants.find(x => x.id === s.userId);
                    return `<span class="claimant-tag"><span>${p?.emoji || '?'}</span>${p?.name || 'User'}</span>`;
                }).join('');

                d.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <div class="font-bold">${it.quantity > 1 ? it.quantity+'x ' : ''}${it.name}</div>
                        <div class="text-green-400 font-bold">$${it.price.toFixed(2)}</div>
                    </div>
                    <div class="mb-3">${claimants}</div>
                    <div class="flex gap-2">
                        ${mySel ? `<button class="btn btn-outline flex-1 text-sm py-2" style="min-height: 44px; color: var(--error);" onclick="unclaim('${it.id}')">Remove</button>` : `
                        <button class="btn btn-success flex-1 text-sm py-2" style="min-height: 44px;" onclick="claim('${it.id}', 'solo')">Solo</button>
                        <button class="btn btn-primary flex-1 text-sm py-2" style="min-height: 44px;" onclick="claim('${it.id}', 'even')">Split</button>
                        `}
                    </div>
                `;
                list.appendChild(d);
            });

            const totalFood = state.session.items.reduce((a, b) => a + b.price, 0);
            const myShare = totalFood > 0 ? (mySub / totalFood) : 0;
            const myTotal = mySub + (state.session.tax * myShare) + (state.session.tip * myShare);
            document.getElementById('runningTotal').textContent = '$' + myTotal.toFixed(2);
            
            document.getElementById('orphanAlert').classList.toggle('hidden', orphans === 0);
            document.getElementById('orphanCount').textContent = orphans;
            const progress = state.session.items.length > 0 ? ((state.session.items.length - orphans) / state.session.items.length) * 100 : 0;
            document.getElementById('claimProgress').style.width = progress + '%';
        }

        function claim(id, type) {
            if (!state.session.selections[id]) state.session.selections[id] = [];
            if (type === 'solo') state.session.selections[id] = [];
            state.session.selections[id].push({ userId: state.userId, type });
            saveSession();
            renderItems();
        }

        function unclaim(id) {
            if (state.session.selections[id]) {
                state.session.selections[id] = state.session.selections[id].filter(s => s.userId !== state.userId);
                saveSession();
                renderItems();
            }
        }

        function reviewSplit() {
            showScreen('review');
            let mySub = 0;
            const itemsList = document.getElementById('yourItems');
            itemsList.innerHTML = '';

            state.session.items.forEach(it => {
                const selections = state.session.selections[it.id] || [];
                const mySel = selections.find(s => s.userId === state.userId);
                if (mySel) {
                    let amt = mySel.type === 'solo' ? it.price : it.price / selections.length;
                    mySub += amt;
                    itemsList.innerHTML += `<div class="flex justify-between text-sm"><span>${it.name}</span><span>$${amt.toFixed(2)}</span></div>`;
                }
            });

            const totalFood = state.session.items.reduce((a, b) => a + b.price, 0);
            const myShare = totalFood > 0 ? (mySub / totalFood) : 0;
            const tax = state.session.tax * myShare;
            const tip = state.session.tip * myShare;
            
            document.getElementById('yourSubtotal').textContent = '$' + mySub.toFixed(2);
            document.getElementById('yourTax').textContent = '$' + tax.toFixed(2);
            document.getElementById('yourTip').textContent = '$' + tip.toFixed(2);
            document.getElementById('yourTotalDisplay').textContent = '$' + (mySub + tax + tip).toFixed(2);
        }

        function goToFinal() { state.session.status = 'final'; saveSession(); showScreen('final'); renderFinal(); }

        function renderFinal() {
            const list = document.getElementById('finalLeaderboard');
            list.innerHTML = '';
            const totals = state.session.participants.map(p => {
                let sub = 0;
                state.session.items.forEach(it => {
                    const sels = state.session.selections[it.id] || [];
                    const s = sels.find(x => x.userId === p.id);
                    if (s) sub += (s.type === 'solo' ? it.price : it.price / sels.length);
                });
                const totalFood = state.session.items.reduce((a, b) => a + b.price, 0);
                const share = totalFood > 0 ? (sub / totalFood) : 0;
                return { ...p, total: sub + (state.session.tax * share) + (state.session.tip * share) };
            }).sort((a, b) => b.total - a.total);

            totals.forEach((t, i) => {
                list.innerHTML += `
                    <div class="card flex items-center gap-4">
                        <div class="text-2xl font-black text-purple-500 w-8">#${i+1}</div>
                        <div class="avatar">${t.emoji}</div>
                        <div class="flex-1 font-bold">${t.name}</div>
                        <div class="text-xl font-black text-green-400">$${t.total.toFixed(2)}</div>
                    </div>
                `;
            });
            
            const totalBill = state.session.items.reduce((a, b) => a + b.price, 0) + state.session.tax + state.session.tip;
            document.getElementById('billTotal').textContent = '$' + totalBill.toFixed(2);
            document.getElementById('splitCountDisplay').textContent = state.session.participants.length + ' people';
        }

        function resetApp() { localStorage.clear(); location.reload(); }
        function updateUI() { if (state.session.status === 'lobby') renderPlayers(); else if (state.session.status === 'selecting') renderItems(); }
    </script>
</body>
</html>
